version: 2.1

description: |
  Automate dynamic security scanning in your build pipeline. Sign up for early access at https://stackhawk.com.
  You will need a StackHawk account to use this Orb.

display:
  source_url: https://github.com/stackhawk/stackhawk-orb
  home_url: https://stackhawk.com

examples:
  "simple_scan":
    description: |
      This is the simplest form of running a StackHawk scan using the `hawkscan` command. Pass your API key as the
      environment variable, `${HAWK_API_KEY}`, and provide a valid `stackhawk.yml` configuration file at the base of
      your repository.
    usage:
      version: 2.1
      orbs:
        stackhawk: stackhawk/stackhawk@x.y
      jobs:
        build:
          machine: true
          steps:
            - checkout
            - stackhawk/hawkscan: {}

commands:
  hawkscan:
    parameters:
      api_key:
        description: >
          Your StackHawk API key; `${HAWK_API_KEY}` by default. Please do not store your key in your CircleCI
          configuration file. Instead store it as an environment variable in CircleCI and pass the variable here.
          Visit https://stackhawk.com if you do not yet have an API key.
        type: string
        default: "${HAWK_API_KEY}"
      color:
        description: >
          Set to `true` if you want HawkScan to output in color. Defaults to `false` since color output can appear
          garbled in job output screens.
        type: boolean
        default: false
      configuration_files:
        description: >
          A list of HawkScan configuration files to load. Defaults to `stackhawk.yml`. To overlay multiple
          configuration files, separate them with spaces, e.g. `stackhawk1.yml stackhawk2.yml stackhawk3.yml`.
        type: string
        default: stackhawk.yml
      docker_image:
        description: >
          The HawkScan container to download. Change this only if recommended by StackHawk Support.
        type: string
        default: stackhawk/hawkscan:latest
      docker_network:
        description: >
          Optional Docker named bridge network on which to run the HawkScan container, such as `scan_net`. Defaults
          to the Docker default bridge named `bridge`.
        type: string
        default: bridge
      auth_endpoint:
        description: >
          The authentication endpoint for HawkScan to use when submitting scan results. Change this only if
          recommended by StackHawk Support.
        type: string
        default: https://auth.stackhawk.com
      results_endpoint:
        description:
          The API endpoint for HawkScan to use when submitting scan results. Change this only if
          recommended by StackHawk Support.
        type: string
        default: https://api.stackhawk.com/api/v1
    steps:
      - run:
          name: Run HawkScan
          command: |
            docker run --network << parameters.docker_network >> --volume $(pwd):/hawk --tty \
              --env SHAWK_AUTH_ENDPOINT="<< parameters.auth_endpoint >>" \
              --env SHAWK_RESULTS_ENDPOINT="<< parameters.results_endpoint >>" \
              --env API_KEY="<< parameters.api_key >>" \
              --env NO_COLOR="<< parameters.color >>" \
              << parameters.docker_image >> << parameters.configuration_files >>
